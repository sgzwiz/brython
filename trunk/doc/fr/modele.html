<html>
<head>
<meta charset="iso-8859-1">
<title>Brython</title>
<link rel="stylesheet" href="../doc_brython.css">
</head>
<body>
<a name="modele"><h3>Compilation et exécution</h3>


<h4>Vue d'ensemble</h4>
<table border=1 cellpadding =5>
<tr><td>Etape</td><td>réalisée par</td></tr>
<tr>
    <td>Lecture du code source Python</td>
    <td>fonction <code>brython(<i>debug_mode</i>)</code> dans <b>py2js.js</b>
        <p>Si le code est dans un fichier externe, il est récupéré par un appel Ajax
        <p>Cette fonction crée les variables d'environnement suivantes :
        <ul>
         <li><code>document.$py_src</code> : objet indexé par les noms de module, contenant le code source du module
         <li><code>document.$debug</code> : le niveau de débogage
         <li><code>document.$exc_stack</code> : une liste avec les erreurs générées en cours d'analyse ou d'exécution
        </ul>
        
    </td>

</tr>

<tr>
    
    <td>création de l'arbre représentant le code Javascript</td>
    <td>fonction <code>$py2js(<i>source,module</i>)</code> dans <b>py2js.js</b>
        <p>Cette fonction appelle :
        <ul>
         <li><code>$tokenize(<i>source</i>)</code> : analyse syntaxique des jetons dans le code source Python et contruction d'un arbre ;
             renvoie la racine de l'arbre
         <li><code>transform(<i>root</i>)</code> : transforme l'arbre pour préparer la conversion en Javascript (cf ci-dessous)
         <li><code>$add_line_num()</code> pour ajouter les numéros de ligne si le mode de débogage est supérieur à 0
        </ul>
        <p>La fonction <code>$py2js</code> renvoie la racine de l'arbre
    </td>
</tr>

<tr>
    
    <td>génération du code Javascript</td>
    <td>méthode <code>to_js()</code> de l'arbre renvoyé par <code>$py2js</code>
        <p>Cette fonction appelle la méthode de même nom sur tous les éléments de syntaxe rencontrés dans l'arbre. Elle renvoie la chaine de caractères contenant le code Javascript. Si le mode de débogage vaut 2, cette chaine est affichée dans la console du navigateur
    </td>
</tr>

<tr>
    
    <td>exécution du code Javascript</td>
    <td>évaluation par la fonction <code>eval()</code>
    
    </td>
</tr>

</table>

<p>
<h4>Fichiers utilisés</h4>

Le fichier <b>brython.js</b> est généré par compilation de plusieurs scripts :
<ul>
<li><b>py2js.js</b> : opère la conversion entre le code Python et le code Javascript
<li><b>py_utils.js</b> : fonctions utilitaires (conversion de types entre Javascript et Python)
<li><b>py_string.js</b> : implémentation de la classe str de Python à partir de l'objet Javascript String
<li><b>py_list.js</b> : implémentation de la classe list de Python à partir de l'objet Javascript Array
<li><b>py_classes.js</b> : regroupe tous les autres types et fonctions intégrés de Python
<li><b>py_import.js</b> : implémentation du mot-clé <tt>import</tt>
<li><b>py_dom.js</b> : interaction avec le document HTML (DOM)
<li><b>py_ajax.js</b> : implémentation d'Ajax
<li><b>py_local_storage.js</b> : implémentation du stockage local HTML5
<li><b>py_svg.py</b> : support de SVG (dessin vectoriel)
</ul>


<p>
<h4>Compléments sur la traduction et l'exécution</h4>

La traduction et l'exécution d'un script Brython par <b>py2js.js</b> passent par les phases suivantes :
<ol>
<li>analyse syntaxique et construction d'un arbre
<p>Cette étape repose sur un automate dont l'état évolue en fonction des jetons rencontrés dans le code source
<p>Le code Python est découpé en jetons qui peuvent avoir les types suivants : 
<ul>
<li>mot-clé
<li>identifiant
<li>littéral (chaine de caractères, entier, réel)
<li>opérateur
<li>point
<li>deux points (:)
<li>parenthèse / crochet / accolade ouvrant ou fermant
<li>affectation (signe =)
<li>fin de ligne
</ul>

<p>Pour chaque jeton, un appel est réalisé à la fonction <tt>$transition()</tt> qui renvoie un nouvel état en fonction de l'état courant et du jeton
<p>A chaque ligne de code source correspond un noeud dans l'arbre (instance de la classe <tt>$Node</tt>)
<p>A chaque élément de syntaxe (identifiant, appel de fonction, expression, opérateur...) correspond une classe décrivant le contexte de cet élément. Les classes sont définies à partir de <code>function $AbstractExprCtx</code> jusqu'à <code>$UnaryCtx</code>
<p>Dans cette étape, des erreurs peuvent être signalées : 
<ul>
<li>erreur de syntaxe
<li>erreur d'indentation
<li>chaine de caractères non terminée
<li>parenthèses non équilibrées
<li>caractère illégal
<li>mot clé Python non géré par Brython
</ul>
<p>
<li>Transformation de l'arbre
<p>Pour certains éléments de la syntaxe Python, il est nécessaire de modifier l'arbre représentant le code source (ajouter des branches) avant de passer à la traduction en Javascript. Ceci est réalisé en appelant récursivement la méthode <code>transform</code> depuis le sommet de l'arbre, et en appliquant la méthode de même nom sur les contextes de chaque noeud
<p>Par exemple, pour le code Python <code>assert <i>condition</i></code> qui produit une branche de l'arbre, cette étape la transforme en une branche <code>if not <i>condition</i></code> et une branche "fille" de celle-ci correspondant à <code>raise AssertionError</code>
<p>Les éléments concernés sont : <code>assert</code>, l'assignation en chaine (<code>x=y=0</code>) et multiple (<code>x,y=1,2</code>), <code>class, def, except, for, try</code>. Cette étape sert aussi à mémoriser les variables déclarées par <code>global</code>

<p>
<li>Exécution du code Javascript généré
<p>Le script généré peut faire appel en cours d'exécution :
<ul>
<li>aux classes intégrées définies dans <tt>py_classes.js, py_string.js, py_list.js, py_dom.js, py_ajax.js, py_local_storage.js, py_svg.js</tt>
<li>à des fonctions internes, non accessibles en Python (leur nom commence systématiquement par $) qui sont pour la plupart dans <tt>$py_utils.js</tt>. Les plus importantes sont :
<ul>
<li><tt>$JS2py</tt> : prend un seul argument et renvoie :
<ul>
<li>l'argument sans changement s'il est d'un type reconnu par Brython (c'est-à-dire s'il possède un attribut <tt>__class__</tt>)
<li>une instance de DOMObject (respectivement DOMEvent) si l'argument est un objet (resp. un événement) DOM
<li>une instance de JSObject "enveloppant" l'argument sinon
</ul>
<li><tt>$MakeArgs</tt> appelée au début de l'exécution de chaque fonction dont la signature comporte au moins un argument. Elle construit un espace de noms à partir des arguments passés à la fonction, en appelant notamment la fonction $JS2py sur tous les arguments
<li><tt>$list_comp</tt> est appelée pour chaque liste en extansion
<li><tt>$lambda</tt> est appelée pour les fonctions anonymes définies par <code>lambda</code>
<li><tt>$test_expr</tt> et <tt>$test_item</tt> sont utilisés dans l'évaluation de conditions combinées par <code>and</code> ou <code>or</code>
</ul>
<li>aux fonctions définies dans le script <tt>py_import.js</tt> pour la gestion des imports
</ul>

<p>En cas d'erreur d'exécution, une trace aussi proche que possible de celle générée par Python est imprimée dans la console du navigateur, ou vers un autre élément défini par <code>sys.stderr</code>

</ol>
</body>
</html>